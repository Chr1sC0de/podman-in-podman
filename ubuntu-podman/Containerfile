FROM ubuntu:25.04

ENV DEBIAN_FRONTEND=noninteractive

# Make APT more reliable in slow/virtualized CI environments
RUN printf "Acquire::Retries \"10\";\nAcquire::http::Timeout \"60\";\n" \
    > /etc/apt/apt.conf.d/80-retries

# Packages roughly equivalent to your old DNF set
# for debian use golang-github-containers-common
ARG INSTALL_PKGS="sudo podman uidmap fuse-overlayfs git openssh-client cpp vim git-core golang-github-containers-common sqlite3 curl ca-certificates openssh-server libcap2-bin"

# FLAVOR logic: stable / testing / upstream
RUN apt-get update && \
    apt-get upgrade && \
    apt-get install -y --no-install-recommends $INSTALL_PKGS && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* 

# Remove unique identifiers like the original Rocky version
RUN rm -f /etc/machine-id && \
    rm -f /var/lib/systemd/random-seed

# ---------------------------------------------------------------------
# Configure rootless Podman user
# ---------------------------------------------------------------------

# Fix newuidmap/newgidmap permissions (critical for Ubuntu 24.04)
RUN chmod u+s /usr/bin/newuidmap /usr/bin/newgidmap && \
    chmod 4755 /usr/bin/newuidmap /usr/bin/newgidmap

# It's assumed `ubuntu` will end up with UID/GID 1000
RUN echo -e "root:1:65535\nubuntu:1:999\nubuntu:1001:64535" > /etc/subuid && \
    echo -e "root:1:65535\nubuntu:1:999\nubuntu:1001:64535" > /etc/subgid


ADD containers.conf /etc/containers/containers.conf
ADD podman-containers.conf /home/ubuntu/.config/containers/containers.conf

RUN mkdir -p /home/ubuntu/.local/share/containers && \
    chown -R ubuntu:ubuntu /home/ubuntu && \
    chmod 644 /etc/containers/containers.conf

RUN curl -o /usr/share/containers/storage.conf \ 
    https://raw.githubusercontent.com/containers/storage/main/storage.conf
#
RUN curl -o /etc/containers/storage.conf \
    https://raw.githubusercontent.com/containers/storage/main/storage.conf

# Modify storage.conf: fuse-overlay in container, shared directories
RUN sed -e 's|^#mount_program|mount_program|g' \
    -e '/additionalimage.*/a "/var/lib/shared",' \
    -e 's|^mountopt *=.*$|mountopt = "nodev,fsync=0"|' \
    /usr/share/containers/storage.conf \
    > /etc/containers/storage.conf

# Subscription passthrough paths (kept as placeholders)
RUN printf '/run/secrets/etc-pki-entitlement:/run/secrets/etc-pki-entitlement\n/run/secrets/rhsm:/run/secrets/rhsm\n' \
    > /etc/containers/mounts.conf

# Volumes â€” same as original
VOLUME /var/lib/containers
VOLUME /home/ubuntu/.local/share/containers

# Shared storage setup similar to Rocky version
RUN mkdir -p /var/lib/shared/overlay-images \
    /var/lib/shared/overlay-layers \
    /var/lib/shared/vfs-images \
    /var/lib/shared/vfs-layers && \
    touch /var/lib/shared/overlay-images/images.lock && \
    touch /var/lib/shared/overlay-layers/layers.lock && \
    touch /var/lib/shared/vfs-images/images.lock && \
    touch /var/lib/shared/vfs-layers/layers.lock

# Replace setuid bits by proper file capabilities for uidmap binaries.
# See <https://github.com/containers/podman/discussions/19931>.
RUN chmod 0755 /usr/bin/newuidmap /usr/bin/newgidmap && \
    setcap cap_setuid=ep /usr/bin/newuidmap && \
    setcap cap_setgid=ep /usr/bin/newgidmap && \
    apt-get autoremove --purge -y libcap2-bin

ENV _CONTAINERS_USERNS_CONFIGURED="" \
    BUILDAH_ISOLATION=chroot

# setup ssh
RUN mkdir -p /var/run/sshd && ssh-keygen -A

RUN sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/' /etc/ssh/sshd_config

RUN chmod 600 /etc/shadow

RUN echo "ubuntu:test" | chpasswd
